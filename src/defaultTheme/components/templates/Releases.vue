<template>
  <AppPage>
    <h1 class="flex-1 text-4xl font-semibold tracking-tight text-gray-900 dark:text-gray-100">
      <span class="flex-1">Releases</span>
    </h1>

    <AppPage>
      <div v-for="release of releases" :key="release.name">
        <div class="flex items-baseline justify-between">
          <ProseH2 :id="release.name">
            <a :href="`#${release.name}`">
              {{ release.name }}
            </a>
          </ProseH2>
          <span class="text-sm font-normal text-gray-500">{{ formatDate($i18n.local, release) }}</span>
        </div>
        <NuxtContent :document="release" class="docus-content" />
      </div>

      <hr class="mt-10 mb-4 border-gray-200 dark:border-gray-800" />

      <template #toc>
        <PageToc :toc="toc" title="Versions" />
      </template>
    </AppPage>
  </AppPage>
</template>

<script>
import { defineComponent, ref, useContext, useFetch, onMounted } from '@nuxtjs/composition-api'
import { scrollToHeading } from '../../utils'

export default defineComponent({
  props: {
    page: {
      type: Object,
      required: true
    }
  },
  setup() {
    const { $docus } = useContext()
    const releases = ref()
    const toc = ref()

    useFetch(async () => {
      const document = await $docus.data('github-releases')

      releases.value = document.releases

      toc.value = document.releases?.map(release => ({
        id: release.name,
        depth: 2,
        text: release.name
      }))
    })

    onMounted(() => {
      if (window.location.hash) {
        const hash = window.location.hash.replace('#', '')

        // do not remove setTimeout (wrong scroll pos)
        setTimeout(() => {
          scrollToHeading(hash, '--docs-scroll-margin-block')
        }, 300)
      }

      // do not remove setTimeout (no headers)
      setTimeout(() => {
        const headings = [
          ...document.querySelectorAll('.prose h1'),
          ...document.querySelectorAll('.prose h2'),
          ...document.querySelectorAll('.prose h3')
        ]
        headings.forEach(heading => {
          heading.addEventListener('click', e => {
            e.preventDefault()
            const hash = e.target.href.split('#').pop()
            scrollToHeading(hash, '--docs-scroll-margin-block')
          })
        })
      }, 500)
    })

    const formatDate = (locale, release) => {
      const currentLocale = locale || 'en'

      const date = new Date(release.date)

      return date.toLocaleDateString(currentLocale)
    }

    return {
      releases,
      toc,
      formatDate
    }
  },
  templateOptions: {
    aside: true
  }
})
</script>
